{% assign dark_bg = 'bg-black' %}
{% assign dark_text = 'text-white' %}
{% assign dark_text_hover = 'hover:text-gray-300' %}
{% assign dark_border = 'border-gray-800' %}
{% assign dark_button = 'bg-gray-900 text-white' %}

<style>
  /* Custom white scrollbar thumb, hidden track */
  .search-scrollbar::-webkit-scrollbar {
    width: 6px;
  }

  .search-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }

  .search-scrollbar::-webkit-scrollbar-thumb {
    background-color: white;
    border-radius: 4px;
  }

  .search-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: white transparent;
  }
</style>

<header class="relative {{ dark_bg }}" x-data="headerComponent()">
  <div class="flex h-10 items-center justify-center bg-pink-900 px-4 text-sm font-medium {{ dark_text }} sm:px-6 lg:px-8">
    {{ settings.free_shipping_message | default: 'Own Every Shot!' }}
  </div>

  <nav aria-label="Top" class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="border-b {{ dark_border }}">
      <div class="flex h-16 items-center">
        <!-- Mobile menu toggle -->
        <button
          type="button"
          class="relative rounded-md {{ dark_button }} p-2 {{ dark_text }} lg:hidden"
          @click="mobileOpen = !mobileOpen"
        >
          <span class="sr-only">Open menu</span>
          <svg class="size-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/>
          </svg>
        </button>

        <!-- Logo -->
        <div class="ml-4 flex lg:ml-0">
          <a href="{{ shop.url }}">
            <span class="sr-only">{{ shop.name }}</span>
            <img class="h-20 w-auto" src="{{ 'logo.svg' | asset_url }}" alt="{{ shop.name }}">
          </a>
        </div>

        <!-- Desktop navigation -->
        <div class="hidden lg:flex lg:items-center lg:ml-8 lg:space-x-4">
          {% for link in linklists['main-menu'].links %}
            <div class="relative group">
              <a href="{{ link.url }}" class="text-sm font-medium {{ dark_text }} {{ dark_text_hover }}">
                {{ link.title }}
              </a>
              {% if link.links != blank %}
                <div class="absolute left-0 mt-2 w-56 {{ dark_bg }} p-4 rounded-lg shadow-lg z-50 opacity-0 group-hover:opacity-100 group-hover:translate-y-0 translate-y-[-10px] transition-all duration-200">
                  {% for child_link in link.links %}
                    <div class="mb-2">
                      <a href="{{ child_link.url }}" class="block text-sm {{ dark_text }} {{ dark_text_hover }}">
                        {{ child_link.title }}
                      </a>
                      {% if child_link.links != blank %}
                        <div class="ml-4 mt-2">
                          {% for grandchild_link in child_link.links %}
                            <a
                              href="{{ grandchild_link.url }}"
                              class="block py-1 text-sm text-gray-400 {{ dark_text_hover }}"
                            >
                              {{ grandchild_link.title }}
                            </a>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <!-- Search, login, cart -->
        <div class="ml-auto flex items-center space-x-4">
          <div class="hidden lg:flex lg:items-center lg:space-x-4">
            <a href="{{ routes.account_login_url }}" class="text-sm font-medium {{ dark_text }} {{ dark_text_hover }}"
              >Sign in</a
            >
            <span class="h-6 w-px bg-gray-800" aria-hidden="true"></span>
            <a
              href="{{ routes.account_register_url }}"
              class="text-sm font-medium {{ dark_text }} {{ dark_text_hover }}"
              >Create account</a
            >
          </div>

          <!-- Search Icon -->
          <div class="relative z-50">
            <button class="p-2 text-gray-400 {{ dark_text_hover }}" @click="toggleSearch">
              <span class="sr-only">Search</span>
              <svg class="size-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197M16 16A7.5 7.5 0 1 0 5 5a7.5 7.5 0 0 0 11 11Z"/>
              </svg>
            </button>
          </div>

          <!-- Cart -->
          <a href="{{ routes.cart_url }}" class="group -m-2 flex items-center p-2">
            <svg
              class="size-6 text-gray-400 {{ dark_text_hover }}"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 0 1-1.12-1.243l1.264-12A1.125 1.125 0 0 1 5.513 7.5h12.974c.576 0 1.059.435 1.119 1.007ZM8.625 10.5a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm7.5 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"/>
            </svg>
            <span class="ml-2 text-sm font-medium {{ dark_text }}">{{ cart.item_count }}</span>
            <span class="sr-only">items in cart, view bag</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Search Modal -->
  <div
    x-show="searchOpen"
    class="absolute top-full left-0 w-full z-50 transition-opacity duration-300"
    x-transition:enter="transition-opacity ease-out duration-300"
    x-transition:leave="transition-opacity ease-in duration-300"
    x-cloak
    @click.outside="searchOpen = false"
  >
    <div class="absolute top-0 left-0 w-full h-[calc(100vh-104px)] bg-black/50" aria-hidden="true"></div>
    <div class="relative mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 {{ dark_bg }} shadow-lg z-50">
      <div class="flex items-center space-x-4">
        <input
          type="text"
          x-model="searchQuery"
          x-on:input.debounce.300ms="fetchSearchSuggestions"
          class="flex-1 {{ dark_bg }} {{ dark_text }} border {{ dark_border }} rounded-full p-3 focus:outline-none focus:ring-2 focus:ring-gray-600 placeholder-gray-400"
          placeholder="Search products..."
        >
        <button @click="searchOpen = false" class="p-2 cursor-pointer text-gray-400 {{ dark_text_hover }}">
          <svg class="size-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="mt-4 space-y-3 max-h-80 overflow-y-auto search-scrollbar" x-html="searchResults"></div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div class="relative  z-40 lg:hidden" aria-modal="true">
    <div
      class="fixed  bg-black/50"
      x-show="mobileOpen"
      x-transition.opacity
      x-cloak
      @click="mobileOpen = false"
    ></div>
    <div
      class="z-40 flex"
      x-show="mobileOpen"
      x-transition:enter="transition transform duration-300 ease-in-out"
      x-cloak
    >
      <div
        class="relative flex w-full max-w-xs flex-col overflow-y-auto {{ dark_bg }} pb-12 shadow-xl transform"
        :class="{'-translate-x-full': !mobileOpen, 'translate-x-0': mobileOpen}"
      >
        <div class="flex justify-end items-end px-4 pt-5 pb-2">
          <button
            type="button"
            class="relative -m-2 inline-flex cursor-pointer items-center justify-center rounded-md p-2 {{ dark_text }}"
            @click="mobileOpen = false"
          >
            <svg class="size-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Mobile nav -->
        <div class="mt-2 border-b {{ dark_border }}">
          <div class="space-y-4 px-4 py-4">
            {% for link in linklists['main-menu'].links %}
              <div x-data="{ open: false }">
                <a
                  href="{{ link.url }}"
                  class="w-full text-left text-base font-medium {{ dark_text }} {{ dark_text_hover }}"
                  {% if link.links != blank %}
                    @click.prevent="open = !open"
                  {% endif %}
                >
                  {{ link.title }}
                </a>
                {% if link.links != blank %}
                  <div class="mt-2 space-y-4 pl-2" x-show="open" x-cloak>
                    {% for child_link in link.links %}
                      <div>
                        <a href="{{ child_link.url }}" class="block text-sm {{ dark_text }} {{ dark_text_hover }}">
                          {{- child_link.title -}}
                        </a>
                        {% if child_link.links != blank %}
                          <ul class="mt-2 space-y-2 pl-4">
                            {% for grandchild_link in child_link.links %}
                              <li>
                                <a
                                  href="{{ grandchild_link.url }}"
                                  class="block text-sm text-gray-400 {{ dark_text_hover }}"
                                >
                                  {{- grandchild_link.title -}}
                                </a>
                              </li>
                            {% endfor %}
                          </ul>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- Sign in / Register -->
        {% if shop.customer_accounts_enabled %}
          <div class="space-y-6 border-t {{ dark_border }} px-4 py-6">
            <div class="flow-root">
              <a
                href="{{ routes.account_login_url }}"
                class="-m-2 block p-2 font-medium {{ dark_text }} {{ dark_text_hover }}"
                >Sign in</a
              >
            </div>
            <div class="flow-root">
              <a
                href="{{ routes.account_register_url }}"
                class="-m-2 block p-2 font-medium {{ dark_text }} {{ dark_text_hover }}"
                >Create account</a
              >
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</header>

<!-- Alpine.js Component -->
<script>
  function headerComponent() {
    return {
      mobileOpen: false,
      searchOpen: false,
      searchQuery: '',
      searchResults: '',

      toggleSearch() {
        this.searchOpen = !this.searchOpen;
        this.searchResults = '';
        this.searchQuery = '';
      },

      async fetchSearchSuggestions() {
        if (this.searchQuery.trim().length < 3) {
          this.searchResults = '';
          return;
        }

        try {
          const res = await fetch(
            `/search/suggest.json?q=${encodeURIComponent(this.searchQuery)}&resources[type]=product`
          );
          const data = await res.json();
          const products = data.resources.results.products;

          if (!products.length) {
            this.searchResults = '<p class="text-gray-400 text-sm">No products found</p>';
            return;
          }

          this.searchResults = products
            .slice(0, 5)
            .map(
              (product) => `
            <div class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-800 transition">
              <img src="${product.image || '{{ "no-image.jpg" | asset_url }}'}" alt="${
                product.title
              }" class="w-12 h-12 object-cover rounded">
              <div>
                <a href="{{product.url}}" class="text-sm text-white hover:text-gray-300">${product.title}</a>
                <p class="text-xs text-gray-400">${product.price ? '$' + (product.price / 100).toFixed(2) : 'N/A'}</p>
              </div>
            </div>
          `
            )
            .join('');
        } catch (err) {
          console.error(err);
          this.searchResults = '<p class="text-gray-400 text-sm">Error loading suggestions</p>';
        }
      },
    };
  }
</script>
